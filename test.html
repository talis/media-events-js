<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.17.1.css">
  <script src="http://code.jquery.com/qunit/qunit-1.17.1.js"></script>
  <script src="mediaAnalytics.js"></script>
 
  <script>
  var _video;

  var removeMediaAnalytics = function() {
     if (_video) {
         _video.pause();

         var videoElements = document.getElementsByTagName('video');
         for (var i = 0 ; i < videoElements.length; i++) {
             var parentElement = videoElements[i].parentNode;
             parentElement.removeChild(videoElements[i]);
         }

         delete(_video);
     }
  }

  var getMediaAnalytics = function() { 
      removeMediaAnalytics();

      var d = document.createElement('div');
      d.innerHTML = '<video controls="controls" webkit-playsinline>'+
            '<source src="http://media.w3.org/2010/05/sintel/trailer.mp4" />' +
            '<source src="http://media.w3.org/2010/05/sintel/trailer.webm" />' +
            '<source src="http://media.w3.org/2010/05/sintel/trailer.ogv" />' +
          '</video>';

      _video = d.firstChild;
      document.getElementsByTagName('body')[0].appendChild(_video);
      _video.load();
      _video.volume = 0;
      return _video;
  }

  var catchExceptions = function(fn, thenFn) {
      return function() {
          try {
              fn();
          } catch (e) {
              msg = e + ": " + e.stack;
              console.log(msg);
              ok(0, msg);
          }
     
          if(thenFn) {
              thenFn();
          } else { 
              start();
          }
      }
  }

  QUnit.testDone(function() {
      removeMediaAnalytics();     
  });

  QUnit.test("tick until 10 seconds", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(mediaEvent));
        events.push(mediaEvent);
    });

    console.info('tick until 10 seconds');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 10 && stage === 0) {
            assert.equal(events.length, 2)
            assert.equal(events[0].type, 'view');
    
            assert.equal(events[1].start, 0);
            assert.equal(events[1].end, 10000);
            assert.equal(events[1].desc, 'segment completed');
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, false);
            stage += 1;
            done();
        }
    });

    video.play();
  });

  QUnit.test("tick just after 10 seconds", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(mediaEvent));
        events.push(mediaEvent);
    });

    console.info('tick just after 10 seconds');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 12 && stage === 0) {
            assert.equal(events.length, 2)
            assert.equal(events[0].type, 'view');
    
            assert.equal(events[1].start, 0);
            assert.equal(events[1].end, 10000);
            assert.equal(events[1].desc, 'segment completed');
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, false);
            stage += 1;
            done();
        }
    });

    video.play();
  });

  QUnit.test("tick to 30 seconds", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(mediaEvent));
        events.push(mediaEvent);
    });

    console.info('tick to 30 seconds');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 30 && stage === 0) {
            assert.equal(events.length, 4)
    
            assert.equal(events[0].type, 'view');
    
            assert.equal(events[1].start, 0);
            assert.equal(events[1].end, 10000);
            assert.equal(events[1].desc, 'segment completed');
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, false);
    
            assert.equal(events[2].start, 10000);
            assert.equal(events[2].end, 20000);
            assert.equal(events[2].desc, 'segment completed');
            assert.equal(events[2].type, 'segment');
            assert.equal(events[2].premature, false);
    
            assert.equal(events[3].start, 20000);
            assert.equal(events[3].end, 30000);
            assert.equal(events[3].desc, 'segment completed');
            assert.equal(events[3].type, 'segment');
            assert.equal(events[3].premature, false);
            stage += 1;
            done();
        }
    });

    video.play();
  });

  QUnit.test("seek forwards", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(events));
        events.push(mediaEvent);
    });

    console.info('seek forwards');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 10 && stage === 0) {
            assert.equal(events.length, 2)
    
            assert.equal(events[0].type, 'view');
    
            assert.equal(events[1].start, 0);
            assert.equal(events[1].end, 10000);
            assert.equal(events[1].desc, 'segment completed');
            assert.equal(events[1].premature, false);
    
            events = new Array();
            video.currentTime = 15.00;
            stage += 1;
        } else if (video.currentTime > 15 && stage === 1) {
            assert.equal(events.length, 2); // TODO: broken

            // TODO: are these numbers OK?
            assert.ok(events[0].start > 10000);
            assert.ok(events[0].start < 14000); // TODO: broken
            assert.ok(events[0].end >= 15000);
            assert.ok(events[0].end < 15500);
            assert.equal(events[0].desc, 'forward seek amount');    
            assert.equal(events[0].type, 'seek');

            assert.equal(events[1].start, 10000);
            assert.equal(events[1].end, events[0].start);
            assert.equal(events[1].desc, 'forward seek');    
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, true);
            stage += 1;
            done();
        }
    });

    video.play();
  });

  QUnit.test("seek forwards, then tick", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(mediaEvent));
        events.push(mediaEvent);
    });

    console.info('seek forwards, then tick');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 10 && stage === 0) {
            assert.equal(events.length, 2)
    
            assert.equal(events[0].type, 'view');
    
            assert.equal(events[1].start, 0);
            assert.equal(events[1].end, 10000);
            assert.equal(events[1].desc, 'segment completed');
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, false);
    
            events = new Array();
            video.currentTime = 15.00;
            stage += 1;
        } else if (video.currentTime > 20 && stage === 1) {
            assert.equal(events.length, 3);

            // TODO: are these numbers OK?
            assert.ok(events[0].start >= 10000);
            assert.ok(events[0].start < 12000);
            assert.ok(events[0].end >= 14800);
            assert.ok(events[0].end < 15500);
            assert.equal(events[0].desc, 'forward seek amount');    
            assert.equal(events[0].type, 'seek');

            assert.equal(events[1].start, 10000);
            assert.equal(events[1].end, events[0].start);
            assert.equal(events[1].desc, 'forward seek');    
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, true);

            assert.ok(events[2].start >= 15000);
            assert.ok(events[2].start < 15500);
            assert.equal(events[2].end, 20000);
            assert.equal(events[2].desc, 'segment completed');    
            assert.equal(events[2].type, 'segment');
            assert.equal(events[2].premature, false);
            stage += 1;
            done();
        }
    });

    video.play();
  });

  QUnit.test("seek backwards", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(mediaEvent));
        events.push(mediaEvent);
    });

    console.info('seek backwards');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 5 && stage === 0) {
            assert.equal(events.length, 1)
            assert.equal(events[0].type, 'view');
            events = new Array();
    
            video.currentTime = 0.100;
            stage += 1;
        } else if (video.currentTime > 1.50 && stage === 1) {
            assert.equal(events.length, 2);

            // TODO: are these numbers OK?
            assert.ok(events[0].start < 5400);
            assert.ok(events[0].end >= 100);
            assert.ok(events[0].end < 500);
            assert.equal(events[0].desc, 'backward seek amount');    
            assert.equal(events[0].type, 'seek');

            assert.equal(events[1].start, 0);
            assert.equal(events[1].end, events[0].start);
            assert.equal(events[1].desc, 'backward seek');    
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, true);
            stage += 1;
            done();
        }
    });

    video.play();
  });

  QUnit.test("seek forwards, then backwards & allow a tick", function(assert) {
    var events = new Array();
    var video = getMediaAnalytics();
    var done = assert.async();
    var stage = 0;

    var mediaAnalytics = new MediaAnalytics(video, function(mediaEvent) {
        console.info(JSON.stringify(mediaEvent));
        events.push(mediaEvent);
    });

    console.info('seek forwards, then backwards & allow a tick');
    video.addEventListener('timeupdate', function() {
        if (video.currentTime > 3 && stage === 0) {
            video.currentTime = 10.00;
            stage += 1;
        } else if (video.currentTime > 10 && stage === 1) {
            assert.equal(events.length, 3);

            assert.equal(events[0].type, 'view');

            // TODO: are these numbers OK?
            // TODO: iphone 4 takes ~ 2.5 seconds to update :S
            assert.ok(events[1].start < 4000);

      var d = document.createElement('b');
      d.innerHTML = events[1].start;
      document.getElementsByTagName('body')[0].appendChild(d);

            assert.ok(events[1].end >= 10000);
            assert.ok(events[1].end < 10500);
            assert.equal(events[1].desc, 'forward seek amount');    
            assert.equal(events[1].type, 'seek');

            assert.equal(events[2].start, 0);
            assert.equal(events[2].end, events[1].start);
            assert.equal(events[2].desc, 'forward seek');    
            assert.equal(events[2].type, 'segment');
            assert.equal(events[2].premature, true);

            events = new Array();
            stage += 1;
        } else if (video.currentTime > 11 && stage === 2) {
            video.currentTime = 0.20;
            stage += 1;
        } else if (video.currentTime > 1.2 && stage === 3) {
            console.info(JSON.stringify(events));
            assert.equal(events.length, 2);

            // TODO: are these numbers OK?
            assert.ok(events[0].start > 11000); // TODO: broken
            assert.ok(events[0].start < 12000);
            assert.ok(events[0].end >= 200);
            assert.ok(events[0].end < 500);
            assert.equal(events[0].desc, 'backward seek amount');    
            assert.equal(events[0].type, 'seek');

            // TODO: end times can be seeked on for up to 100ms
            assert.ok(events[1].start >= 10000);
            assert.ok(events[1].start <= 10500);
            assert.equal(events[1].end, events[0].start);
            assert.equal(events[1].desc, 'backward seek');    
            assert.equal(events[1].type, 'segment');
            assert.equal(events[1].premature, true);
            stage += 1;
            done();
        }
    });

    video.play();
  });

/*
  QUnit.test("seek forwards then hit a tick", function(assert) {
    var timeTracker = new MediaAnalytics();
    assert.equal(timeTracker.timeupdate(200), null);

    var results = timeTracker.timeupdate(10500);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 10500);
    assert.equal(results[0].desc, 'forward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 0);
    assert.equal(results[1].end, 200);
    assert.equal(results[1].desc, 'forward');    
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);

    timeTracker.timeupdate(10600);
    for(x = 10600; x <= 19800; x+= 200) {
        assert.equal(timeTracker.timeupdate(x), null);
    }

    var results = timeTracker.timeupdate(20000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 10500);
    assert.equal(results[0].end, 20000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("modified tolerences", function(assert) {
    assert.equal("", "");
  });

  QUnit.test("non zero start time", function(assert) {
    var timeTracker = new MediaAnalytics();
    timeTracker.setStartTime(2000);

    for(x = 2000; x < 10000; x += 200) {
        assert.equal(timeTracker.timeupdate(x), null); 
    }

    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 2000);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("pause", function(assert) {
    var timeTracker = new MediaAnalytics();
    timeTracker.timeupdate(200);

    var results = timeTracker.pause();
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 200);
    assert.equal(results[0].desc, 'pause');
    assert.equal(results[0].type, 'segment');
 
    assert.equal(results[1].time, 200);
    assert.equal(results[1].desc, 'paused');
    assert.equal(results[1].type, 'pause');

    for(x = 400; x < 10000; x+= 200) {
        timeTracker.timeupdate(x);
    }

    results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);  
  });

  QUnit.test("end of stream", function(assert) {
    var timeTracker = new MediaAnalytics();
    timeTracker.timeupdate(200);
    var results = timeTracker.end(400);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 400);
    assert.equal(results[0].desc, 'end');
    assert.equal(results[0].type, 'segment');
  });

  QUnit.test("end of stream, then restart", function(assert) {
    var timeTracker = new MediaAnalytics();

    for(x = 200; x < 10000; x+= 200) {
        timeTracker.timeupdate(x);
    }

    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);

    results = timeTracker.end(10200);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 10000);
    assert.equal(results[0].end, 10200);
    assert.equal(results[0].desc, 'end');
    assert.equal(results[0].type, 'segment');

    assert.equal(timeTracker.timeupdate(150), null);
 
    for(x = 200; x < 10000; x+= 200) {
        timeTracker.timeupdate(x);
    }

    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });
*/
  </script>
</head>
<body>
    <div id="qunit"></div>
</body>
</html>
