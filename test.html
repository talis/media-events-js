<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.17.1.css">
  <script src="http://code.jquery.com/qunit/qunit-1.17.1.js"></script>
  <script src="mediaAnalytics.js"></script>
 
  <script>
  var video = document.createElement('video');

  QUnit.test("tick until 10 seconds", function( assert ) {
    var timeTracker = new MediaAnalytics(video, function(mediaEvent) {
        assert.equal(mediaEvent.start, 0);
        assert.equal(mediaEvent.end, 10000);
        assert.equal(mediaEvent.desc, 'segment');
        assert.equal(mediaEvent.premature, false);       
    });

    for(x = 0; x < 10000; x += 200) {
        timeTracker.timeupdate(x);
    }

    timeTracker.timeupdate(10000);
  });

  QUnit.test("tick just after 10 seconds", function(assert) {
    var timeTracker = new MediaAnalytics();

    for(x = 0; x < 10000; x += 200) {
        assert.equal(timeTracker.timeupdate(x), null); 
    }

    var results = timeTracker.timeupdate(10100);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("tick to 30 seconds", function(assert) {
    var timeTracker = new MediaAnalytics();
    var results = Array();

    for(x = 0; x <= 30000; x += 200) {
        var result = timeTracker.timeupdate(x); 
        if(result !== null) {
            console.info(result);
            results = results.concat(result);
            console.info(results);
        }
    }

    assert.equal(results.length, 3);

    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);

    assert.equal(results[1].start, 10000);
    assert.equal(results[1].end, 20000);
    assert.equal(results[1].desc, 'segment');
    assert.equal(results[1].premature, false);

    assert.equal(results[2].start, 20000);
    assert.equal(results[2].end, 30000);
    assert.equal(results[2].desc, 'segment');
    assert.equal(results[2].premature, false);
  });

  QUnit.test("seek forwards", function(assert) {
    var timeTracker = new MediaAnalytics();
    assert.equal(timeTracker.timeupdate(200), null);

    var results = timeTracker.timeupdate(10500);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 10500);
    assert.equal(results[0].desc, 'forward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 0);
    assert.equal(results[1].end, 200);
    assert.equal(results[1].desc, 'forward');    
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);
  });

  QUnit.test("seek forwards, then tick", function(assert) {
    var timeTracker = new MediaAnalytics();
    assert.equal(timeTracker.timeupdate(200), null);

    var results = timeTracker.timeupdate(19800);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 19800);
    assert.equal(results[0].desc, 'forward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 0);
    assert.equal(results[1].end, 200);
    assert.equal(results[1].desc, 'forward');    
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);

    results = timeTracker.timeupdate(20000);
    assert.equal(results.length, 1);

    assert.equal(results[0].start, 19800);
    assert.equal(results[0].end, 20000);
    assert.equal(results[0].desc, 'segment');    
    assert.equal(results[0].type, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("seek backwards", function(assert) {
    var timeTracker = new MediaAnalytics();
    for(x = 200; x <= 9800; x+= 200) {
        assert.equal(timeTracker.timeupdate(x), null);
    }

    var results = timeTracker.timeupdate(0);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 9800);
    assert.equal(results[0].end, 0);
    assert.equal(results[0].desc, 'backward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 0);
    assert.equal(results[1].end, 9800);
    assert.equal(results[1].desc, 'backward');
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);
  });

  QUnit.test("seek forwards, then backwards & allow a tick", function(assert) {
    var timeTracker = new MediaAnalytics();
    assert.equal(timeTracker.timeupdate(200), null);

    var results = timeTracker.timeupdate(10500);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 10500);
    assert.equal(results[0].desc, 'forward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 0);
    assert.equal(results[1].end, 200);
    assert.equal(results[1].desc, 'forward');    
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);

    assert.equal(timeTracker.timeupdate(10600), null);

    var results = timeTracker.timeupdate(0);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 10600);
    assert.equal(results[0].end, 0);
    assert.equal(results[0].desc, 'backward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 10500);
    assert.equal(results[1].end, 10600);
    assert.equal(results[1].desc, 'backward');    
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);
   
    for(x = 200; x <= 9800; x+= 200) {
        assert.equal(timeTracker.timeupdate(x), null);
    }
 
    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("seek forwards then hit a tick", function(assert) {
    var timeTracker = new MediaAnalytics();
    assert.equal(timeTracker.timeupdate(200), null);

    var results = timeTracker.timeupdate(10500);
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 10500);
    assert.equal(results[0].desc, 'forward');
    assert.equal(results[0].type, 'seek');

    assert.equal(results[1].start, 0);
    assert.equal(results[1].end, 200);
    assert.equal(results[1].desc, 'forward');    
    assert.equal(results[1].type, 'segment');
    assert.equal(results[1].premature, true);

    timeTracker.timeupdate(10600);
    for(x = 10600; x <= 19800; x+= 200) {
        assert.equal(timeTracker.timeupdate(x), null);
    }

    var results = timeTracker.timeupdate(20000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 10500);
    assert.equal(results[0].end, 20000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("modified tolerences", function(assert) {
    assert.equal("", "");
  });

  QUnit.test("non zero start time", function(assert) {
    var timeTracker = new MediaAnalytics();
    timeTracker.setStartTime(2000);

    for(x = 2000; x < 10000; x += 200) {
        assert.equal(timeTracker.timeupdate(x), null); 
    }

    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 2000);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });

  QUnit.test("pause", function(assert) {
    var timeTracker = new MediaAnalytics();
    timeTracker.timeupdate(200);

    var results = timeTracker.pause();
    assert.equal(results.length, 2);

    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 200);
    assert.equal(results[0].desc, 'pause');
    assert.equal(results[0].type, 'segment');
 
    assert.equal(results[1].time, 200);
    assert.equal(results[1].desc, 'paused');
    assert.equal(results[1].type, 'pause');

    for(x = 400; x < 10000; x+= 200) {
        timeTracker.timeupdate(x);
    }

    results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);

    assert.equal(results[0].start, 200);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);  
  });

  QUnit.test("end of stream", function(assert) {
    var timeTracker = new MediaAnalytics();
    timeTracker.timeupdate(200);
    var results = timeTracker.end(400);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 400);
    assert.equal(results[0].desc, 'end');
    assert.equal(results[0].type, 'segment');
  });

  QUnit.test("end of stream, then restart", function(assert) {
    var timeTracker = new MediaAnalytics();

    for(x = 200; x < 10000; x+= 200) {
        timeTracker.timeupdate(x);
    }

    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);

    results = timeTracker.end(10200);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 10000);
    assert.equal(results[0].end, 10200);
    assert.equal(results[0].desc, 'end');
    assert.equal(results[0].type, 'segment');

    assert.equal(timeTracker.timeupdate(150), null);
 
    for(x = 200; x < 10000; x+= 200) {
        timeTracker.timeupdate(x);
    }

    var results = timeTracker.timeupdate(10000);
    assert.equal(results.length, 1);
    assert.equal(results[0].start, 0);
    assert.equal(results[0].end, 10000);
    assert.equal(results[0].desc, 'segment');
    assert.equal(results[0].premature, false);
  });
  </script>
</head>
<body>
    <div id="qunit"></div>
</body>
</html>
